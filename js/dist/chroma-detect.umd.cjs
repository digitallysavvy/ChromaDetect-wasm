(function(d,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("../wasm/chroma_detect")):typeof define=="function"&&define.amd?define(["exports","../wasm/chroma_detect"],s):(d=typeof globalThis<"u"?globalThis:d||self,s(d.ChromaDetect={},d.init))})(this,function(d,s){"use strict";var L=Object.defineProperty;var p=(d,s,g)=>s in d?L(d,s,{enumerable:!0,configurable:!0,writable:!0,value:g}):d[s]=g;var l=(d,s,g)=>p(d,typeof s!="symbol"?s+"":s,g);class g{constructor(){l(this,"detector",null);l(this,"initialized",!1)}async init(){this.initialized||(await s(),this.detector=new s.ChromaDetect,this.initialized=!0)}setConfig(e){this.detector&&this.detector.set_config(e)}async detectFromImage(e){if(!this.detector)throw new Error("Not initialized");const t=this.toImageData(e),n=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength);return this.detector.detect_from_image(n,t.width,t.height)}toImageData(e){if(e instanceof ImageData)return e;const t=document.createElement("canvas"),n=t.getContext("2d");return e instanceof HTMLImageElement?(t.width=e.naturalWidth,t.height=e.naturalHeight,n.drawImage(e,0,0)):(t.width=e.width,t.height=e.height,n.drawImage(e,0,0)),n.getImageData(0,0,t.width,t.height)}}class w{constructor(){l(this,"detector",null);l(this,"initialized",!1)}async init(){this.initialized||(await s(),this.detector=new s.ChromaDetect,this.initialized=!0)}setConfig(e){this.detector&&this.detector.set_config(e)}async detectFromVideo(e,t={}){if(!this.detector)throw new Error("Not initialized");const{frameSampleCount:n=8,sampleStrategy:r="uniform",maxDuration:o=30}=t,a=e instanceof File,i=a?await this.loadVideoFile(e):e;try{await this.ensureVideoReady(i);const m=this.calculateFrameTimestamps(i.duration,n,r,o);this.detector.start_video_analysis();for(const u of m)try{const h=await this.extractFrame(i,u),c=new Uint8Array(h.data.buffer,h.data.byteOffset,h.data.byteLength);this.detector.add_video_frame(c,h.width,h.height)}catch(h){console.warn(`Failed to extract frame at ${u}s`,h)}return this.detector.get_video_consensus()}finally{a&&i.src.startsWith("blob:")&&URL.revokeObjectURL(i.src)}}calculateFrameTimestamps(e,t,n,r){const o=Math.min(e,r);if(n==="uniform"){const a=o/(t+1);return Array.from({length:t},(i,m)=>(m+1)*a)}else{const a=[],i=Math.floor(t*.4);for(let c=0;c<i;c++)a.push(o*.1*c/i);const m=o*.9;for(let c=0;c<i;c++)a.push(m+o*.1*c/i);const f=t-i*2,u=o*.3,h=o*.7;for(let c=0;c<f;c++)a.push(u+(h-u)*c/f);return a.sort((c,E)=>c-E)}}async ensureVideoReady(e){return new Promise((t,n)=>{if(e.readyState>=4){t();return}const r=()=>{e.removeEventListener("canplaythrough",r),e.removeEventListener("error",o),clearTimeout(a),t()},o=i=>{e.removeEventListener("canplaythrough",r),e.removeEventListener("error",o),clearTimeout(a),n(new Error("Video failed to load: "+i.message))};e.addEventListener("canplaythrough",r),e.addEventListener("error",o);const a=setTimeout(()=>{e.removeEventListener("canplaythrough",r),e.removeEventListener("error",o),n(new Error("Video load timeout"))},3e4);e.load()})}async extractFrame(e,t){return new Promise((n,r)=>{const o=document.createElement("canvas"),a=o.getContext("2d"),i=()=>{o.width=e.videoWidth,o.height=e.videoHeight,a.drawImage(e,0,0);const u=a.getImageData(0,0,o.width,o.height);e.removeEventListener("seeked",i),clearTimeout(f),n(u)},m=()=>{e.removeEventListener("seeked",i),clearTimeout(f),r(new Error("Seek failed"))};e.addEventListener("seeked",i),e.addEventListener("error",m),e.currentTime=t;const f=setTimeout(()=>{e.removeEventListener("seeked",i),e.removeEventListener("error",m),r(new Error("Frame extraction timeout"))},5e3)})}async loadVideoFile(e){return new Promise((t,n)=>{const r=document.createElement("video"),o=URL.createObjectURL(e);r.preload="auto",r.muted=!0,r.src=o;const a=()=>{r.removeEventListener("canplaythrough",a),r.removeEventListener("error",i),clearTimeout(m),t(r)},i=()=>{r.removeEventListener("canplaythrough",a),r.removeEventListener("error",i),clearTimeout(m),URL.revokeObjectURL(o),n(new Error("Failed to load video"))};r.addEventListener("canplaythrough",a),r.addEventListener("error",i);const m=setTimeout(()=>{r.removeEventListener("canplaythrough",a),r.removeEventListener("error",i),URL.revokeObjectURL(o),n(new Error("Video load timeout"))},3e4)})}}class y{constructor(){l(this,"imageProcessor");l(this,"videoProcessor");l(this,"config",{});this.imageProcessor=new g,this.videoProcessor=new w}async init(){await Promise.all([this.imageProcessor.init(),this.videoProcessor.init()])}setConfig(e){this.config={...this.config,...e},this.imageProcessor.setConfig(this.config),this.videoProcessor.setConfig(this.config)}async detectFromImage(e){if(e instanceof File){const t=await this.loadImage(e);return this.imageProcessor.detectFromImage(t)}return this.imageProcessor.detectFromImage(e)}async detectFromVideo(e,t){return this.videoProcessor.detectFromVideo(e,t)}loadImage(e){return new Promise((t,n)=>{const r=new Image,o=URL.createObjectURL(e);r.onload=()=>{URL.revokeObjectURL(o),t(r)},r.onerror=()=>{URL.revokeObjectURL(o),n(new Error("Failed to load image"))},r.src=o})}}d.ChromaDetect=y,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
